<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <title>Iris - åœ–ç‰‡ç®¡ç†</title>
    <style>
        #dropzone.dragover {
            background-color: #e0f2fe;
            border-color: #3b82f6;
            color: #2563eb;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">
    <!-- å°è¦½åˆ— -->
    <header class="bg-white shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-bold text-gray-800">
                <a href="#">åœ–ç‰‡ç®¡ç†ç³»çµ±</a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="admin.html" class="text-blue-600 hover:text-blue-800 font-semibold">
                    <i class="fas fa-cogs mr-1"></i>å‰å¾€å¾Œå°ç®¡ç†
                </a>
                <button id="logout-button" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">
                    <i class="fas fa-sign-out-alt mr-1"></i>ç™»å‡º
                </button>
            </div>
        </nav>
    </header>

    <!-- ä¸»è¦å…§å®¹ï¼ˆä½ çš„åœ–ç‰‡ä¸Šå‚³ + æœå°‹å€å¡Šç­‰ï¼‰ -->
    <main class="p-6">
        <div id="app-content">
            <div class="max-w-3xl mx-auto bg-white rounded shadow p-6">
                <h1 class="text-2xl font-bold mb-4 text-gray-800">Iris - åœ–ç‰‡ç®¡ç†</h1>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">å•†å“ç·¨è™Ÿï¼ˆè³‡æ–™å¤¾ï¼‰</label>
                    <input type="text" id="folderInput" class="w-full border p-2 rounded mb-4" placeholder="ä¾‹å¦‚ï¼šABC123" />

                    <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡åœ–ç‰‡ä¸Šå‚³</label>
                    <div id="dropzone" class="w-full border-2 border-dashed border-gray-300 p-6 rounded text-center text-gray-500 cursor-pointer hover:border-blue-400 transition-all">
                        å°‡åœ–ç‰‡æ‹–æ‹‰åˆ°æ­¤å€åŸŸï¼Œæˆ–é»æ“Šé¸æ“‡
                    </div>
                    <input type="file" id="imageInput" accept="image/*" multiple class="hidden" />

                    <button id="uploadBtn" class="mt-4 mb-2 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:opacity-50" disabled>
                        <i class="fas fa-upload mr-2"></i>ä¸Šå‚³åœ–ç‰‡
                    </button>

                    <!-- é è¦½å€ -->
                    <div id="previewArea" class="flex flex-wrap gap-4 mt-4"></div>
                </div>
                <div class="mb-6 border-t pt-6">
                    <label for="folderFilter" class="block text-sm font-medium text-gray-700 mb-2">
                        æœå°‹è³‡æ–™å¤¾
                    </label>
                    <input type="text" id="folderFilter" placeholder="è¼¸å…¥è³‡æ–™å¤¾åç¨±..." class="w-full p-2 border rounded" />
                </div>
                <div>
                    <h2 class="text-lg font-semibold mb-2">åœ–ç‰‡æ¸…å–®</h2>
                    <div id="imageList" class="space-y-6"></div>
                </div>
            </div>
        </div>
    </main>


    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script>
        // ä½ çš„ Firebase é…ç½®ç‰©ä»¶ (å¾ Firebase æ§åˆ¶å°å–å¾—ä¸¦è²¼åˆ°é€™è£¡)
        const firebaseConfig = {
            apiKey: "AIzaSyB7JlDaqB3dm9hpuXrLmxHNr9lBKDznkD0",
            authDomain: "iris-wear.firebaseapp.com",
            projectId: "iris-wear",
            storageBucket: "iris-wear.firebasestorage.app",
            messagingSenderId: "720824939218",
            appId: "1:720824939218:web:13594d0ff6954ee726330b",
            measurementId: "G-53QJG70PJT"
        };

        // åˆå§‹åŒ– Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase åˆå§‹åŒ–æˆåŠŸï¼");
        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼š", error);
            document.body.innerHTML = '<div class="text-center p-12 text-red-600">Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯å’Œé…ç½®ã€‚</div>';
            throw new Error("Firebase initialization failed");
        }


        // å–å¾— Auth å¯¦ä¾‹
        const auth = firebase.auth();
        console.log("Firebase Auth å¯¦ä¾‹å·²å–å¾—");

        // !!! Firebase èªè­‰æª¢æŸ¥ !!!
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œé›»å­éƒµä»¶:", user.email);
                document.body.style.display = 'block'; // é¡¯ç¤º body å…§å®¹
            } else {
                console.log("æ²’æœ‰ä½¿ç”¨è€…ç™»å…¥ï¼Œé‡æ–°å°å‘åˆ°ç™»å…¥é é¢ã€‚");
                window.location.href = 'login.html'; // é‡æ–°å°å‘åˆ°æ‚¨çš„ç™»å…¥é é¢
            }
        });
        // !!! èªè­‰æª¢æŸ¥çµæŸ !!!

        // å–å¾— Firestore å¯¦ä¾‹
        const db = firebase.firestore();

        let GITHUB_TOKEN = '';

        function loadToken() {
            return db.collection('settings').doc('git').get().then(doc => {
                if (doc.exists && doc.data().token) {
                    GITHUB_TOKEN = doc.data().token;
                    console.log("âœ” å–å¾— GITHUB_TOKENï¼š");
                } else {
                    console.warn("âš ï¸ æ‰¾ä¸åˆ° GitHub token è¨­å®š");
                }
            }).catch(error => {
                console.error("è®€å– GitHub token æ™‚å‡ºéŒ¯ï¼š", error);
            });
        }

        // é é¢è¼‰å…¥å¾ŒåŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            loadToken().then(() => {
                loadFolderImages(); // âœ… ç­‰ token å¾Œæ‰è¼‰å…¥æ¸…å–®
            });
        });


        const REPO_OWNER = 'kijmothy';
        const REPO_NAME = 'iris-site';
        const BRANCH = 'main';
        const GITHUB_API = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/images`;
        const RAW_BASE = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/images`;

        const uploadBtn = document.getElementById('uploadBtn');
        const imageInput = document.getElementById('imageInput');
        const imageList = document.getElementById('imageList');
        const folderInput = document.getElementById('folderInput');

        imageInput.addEventListener('change', () => {
            uploadBtn.disabled = !imageInput.files.length;

            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = ''; // æ¸…ç©ºå…ˆå‰é è¦½

            Array.from(imageInput.files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-24 h-24 object-cover rounded border';
                    previewArea.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        uploadBtn.addEventListener('click', async () => {
            const folder = folderInput.value.trim();
            // âœ… æª¢æŸ¥æ˜¯å¦æœ‰è¼¸å…¥å•†å“ç·¨è™Ÿ
            if (!folder) {
                alert('âš ï¸ è«‹å…ˆè¼¸å…¥å•†å“ç·¨è™Ÿï¼ˆè³‡æ–™å¤¾åç¨±ï¼‰');
                folderInput.focus();
                return;
            }
            const files = selectedFiles.length ? selectedFiles : imageInput.files;
            if (!files.length) return;

            uploadBtn.disabled = true;
            uploadBtn.textContent = 'ä¸Šå‚³ä¸­...';

            for (const file of files) {
                const filename = file.name;
                const fullPath = folder ? `${folder}/${filename}` : filename;

                const reader = new FileReader();
                await new Promise((resolve, reject) => {
                    reader.onload = async () => {
                        const base64 = reader.result.split(',')[1];

                        const url = `${GITHUB_API}/${fullPath}`;
                        const body = {
                            message: `upload ${fullPath}`,
                            content: base64,
                            branch: BRANCH
                        };

                        try {
                            const res = await fetch(url, {
                                method: 'PUT',
                                headers: {
                                    Authorization: `Bearer ${GITHUB_TOKEN}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(body)
                            });

                            const data = await res.json();
                            if (res.ok) {
                                const folderContainer = getOrCreateFolderContainer(folder);
                                renderImageItem({
                                    name: fullPath,
                                    url: `${RAW_BASE}/${fullPath}`
                                }, folderContainer.querySelector('.images'));
                            } else {
                                alert(`ä¸Šå‚³ ${filename} å¤±æ•—: ` + data.message);
                            }
                        } catch (err) {
                            console.error(`ä¸Šå‚³ ${filename} ç™¼ç”ŸéŒ¯èª¤`, err);
                        }

                        resolve(); // ç¢ºä¿ç­‰å¾…æ¯å€‹ reader.onload çµæŸå†ç¹¼çºŒ
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            alert('å…¨éƒ¨ä¸Šå‚³å®Œæˆ');
            uploadBtn.textContent = 'ä¸Šå‚³åœ–ç‰‡';
            imageInput.value = ''; // æ¸…ç©º input
            folderInput.value = ''; // æ¸…ç©º input
            document.getElementById('previewArea').innerHTML = ''; // æ¸…ç©ºé è¦½
            uploadBtn.disabled = true; // é¿å…æœªé¸æª”ä»å¯é»æ“Š
        });

        function getOrCreateFolderContainer(folder) {
            const id = `folder-${folder}`;
            let container = document.getElementById(id);
            if (container) return container;

            container = document.createElement('div');
            container.id = id;
            container.className = 'border rounded p-4';

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center cursor-pointer select-none';
            header.innerHTML = `<span class="font-bold text-gray-800">ğŸ“ ${folder || '(æ ¹ç›®éŒ„)'}</span>`;

            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = 'æ”¶åˆ';
            toggleBtn.className = 'text-sm text-blue-600 hover:underline';
            toggleBtn.onclick = () => {
                images.classList.toggle('hidden');
                toggleBtn.textContent = images.classList.contains('hidden') ? 'å±•é–‹' : 'æ”¶åˆ';
            };
            if (folder !== '') {
                header.appendChild(toggleBtn);
                const deleteBtn = document.createElement('button');
                //deleteBtn.textContent = 'åˆªé™¤æ­¤è³‡æ–™å¤¾';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt" title="åˆªé™¤æ­¤è³‡æ–™å¤¾"></i>';
                //deleteBtn.className = 'text-sm text-red-600 hover:underline ml-4';
                deleteBtn.className = 'px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600';
                deleteBtn.onclick = async () => {
                    if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ•´å€‹è³‡æ–™å¤¾ ${folder} å—ï¼Ÿ`)) return;

                    const folderUrl = `${GITHUB_API}/${folder}`;
                    const res = await fetch(folderUrl, {
                        headers: {
                            Authorization: `Bearer ${GITHUB_TOKEN}`
                        }
                    });

                    const files = await res.json();
                    if (!Array.isArray(files)) {
                        alert('è³‡æ–™å¤¾è®€å–å¤±æ•—');
                        return;
                    }

                    for (const file of files) {
                        const delRes = await fetch(`${GITHUB_API}/${file.path.replace('images/', '')}`, {
                            method: 'DELETE',
                            headers: {
                                Authorization: `Bearer ${GITHUB_TOKEN}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: `delete ${file.path}`,
                                sha: file.sha,
                                branch: BRANCH
                            })
                        });

                        if (!delRes.ok) {
                            const err = await delRes.json();
                            alert(`åˆªé™¤ ${file.name} å¤±æ•—: ${err.message}`);
                            return;
                        }
                    }

                    alert('è³‡æ–™å¤¾å·²åˆªé™¤');
                    container.remove();
                };

                header.appendChild(deleteBtn);
            }
            // ğŸ”½ ğŸ”½ ğŸ”½ åŠ åœ¨é€™è£¡
            header.addEventListener('click', (e) => {
                if (e.target.closest('button')) return; // é¿å…é»åˆ°æŒ‰éˆ•ä¹Ÿè§¸ç™¼
                images.classList.toggle('hidden');
                toggleBtn.textContent = images.classList.contains('hidden') ? 'å±•é–‹' : 'æ”¶åˆ';
            });
            const images = document.createElement('div');
            images.className = 'images space-y-2 mt-4 hidden'; // â† åŠ ä¸Š hidden
            toggleBtn.textContent = 'å±•é–‹'; // â† æŒ‰éˆ•é è¨­æ–‡å­—ç‚ºã€Œå±•é–‹ã€

            container.appendChild(header);
            container.appendChild(images);
            imageList.appendChild(container);

            return container;
        }

        function renderImageItem(img, container) {
            const li = document.createElement('div');
            li.className = 'flex items-center space-x-4';

            const image = document.createElement('img');
            image.src = img.url;
            image.alt = img.name;
            image.className = 'w-20 h-20 object-cover rounded border';

            const name = document.createElement('span');
            name.textContent = img.name.split('/').pop();
            name.className = 'flex-1';

            const delBtn = document.createElement('button');
            //delBtn.textContent = 'åˆªé™¤';
            delBtn.innerHTML = '<span title="åˆªé™¤" class="text-red-500 text-lg hover:text-red-700">âŒ</span>';
            delBtn.onclick = async () => {
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${img.name} å—ï¼Ÿ`)) return;

                const shaRes = await fetch(`${GITHUB_API}/${img.name}`, {
                    headers: {
                        Authorization: `Bearer ${GITHUB_TOKEN}`
                    }
                });
                const shaData = await shaRes.json();

                const delRes = await fetch(`${GITHUB_API}/${img.name}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `Bearer ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `delete ${img.name}`,
                        sha: shaData.sha,
                        branch: BRANCH
                    })
                });

                if (delRes.ok) {
                    alert('åˆªé™¤æˆåŠŸ');
                    li.remove();

                    // âœ… æ–°å¢ï¼šè‹¥è³‡æ–™å¤¾å…§ç„¡åœ–ç‰‡ï¼Œè‡ªå‹•ç§»é™¤è³‡æ–™å¤¾å®¹å™¨
                    const parentFolder = container.closest('.border.rounded');
                    const remaining = container.querySelectorAll('div.flex');
                    if (parentFolder && remaining.length === 0) {
                        parentFolder.remove();
                    }
                } else {
                    const err = await delRes.json();
                    alert('åˆªé™¤å¤±æ•—: ' + err.message);
                }
            };

            li.appendChild(image);
            li.appendChild(name);
            li.appendChild(delBtn);
            container.appendChild(li);
        }

        async function loadFolderImages(path = '') {
            const res = await fetch(`${GITHUB_API}${path ? `/${path}` : ''}`, {
                headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`
                }
            });
            const data = await res.json();
            if (Array.isArray(data)) {
                // âœ… æ’åºï¼ˆæŒ‰æª”å Aâ†’Zï¼‰
                data.sort((a, b) => a.name.localeCompare(b.name, 'zh-Hant', {
                    numeric: true
                }));
                for (const file of data) {
                    if (file.type === 'file' && /\.(png|jpe?g|gif|webp)$/i.test(file.name)) {
                        const folder = path;
                        const container = getOrCreateFolderContainer(folder);
                        renderImageItem({
                            name: file.path.replace('images/', ''),
                            url: file.download_url
                        }, container.querySelector('.images'));
                    } else if (file.type === 'dir') {
                        await loadFolderImages(path ? `${path}/${file.name}` : file.name);
                    }
                }
            }
        }

        document.getElementById('folderFilter').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            document.querySelectorAll('#imageList > .border.rounded').forEach(folder => {
                const folderName = folder.querySelector('span').textContent.toLowerCase();
                folder.style.display = folderName.includes(keyword) ? 'block' : 'none';
            });
        });


        const dropzone = document.getElementById('dropzone');
        const previewArea = document.getElementById('previewArea');

        let selectedFiles = []; // ğŸ”¸ ä¿ç•™é¸å–çš„æª”æ¡ˆ

        dropzone.addEventListener('click', () => imageInput.click());

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            handleFiles(files);
        });

        function handleFiles(files) {
            if (!files.length) return;

            // âœ… æ¸…ç©ºä¹‹å‰çš„æª”æ¡ˆèˆ‡é è¦½
            selectedFiles = [];
            previewArea.innerHTML = '';

            // âœ… åŠ å…¥æ–°æª”æ¡ˆ
            selectedFiles = files;
            uploadBtn.disabled = false;

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'w-24 h-24 object-cover rounded border';
                    previewArea.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }



        // ç²å–ç™»å‡ºæŒ‰éˆ•
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    console.log("ä½¿ç”¨è€…å·²ç™»å‡ºï¼");
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error("ç™»å‡ºå¤±æ•—ï¼š", error);
                    alert("ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
                }
            });
            console.log("ç™»å‡ºæŒ‰éˆ•äº‹ä»¶å·²ç¶å®šã€‚");
        } else {
            console.warn("æ‰¾ä¸åˆ° ID ç‚º 'logout-button' çš„å…ƒç´ ã€‚");
        }
    </script>
</body>

</html>